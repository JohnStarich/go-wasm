<html>

<head>
	<meta charset="utf-8" />
	<script src="wasm_exec.js"></script>
	<script src="js/reload.js"></script>
	<script src="js/util.js"></script>
	<script src="fetch.js"></script>
	<script>
		if (!WebAssembly.instantiateStreaming) { // polyfill
			WebAssembly.instantiateStreaming = async (resp, importObject) => {
				const source = await (await resp).arrayBuffer();
				return await WebAssembly.instantiate(source, importObject);
			};
		}

		const startTime = new Date().getTime()
		const go = new Go();
		WebAssembly.instantiateStreaming(fetch(`main.wasm`), go.importObject)
			.catch(e => {
				console.error("Failed to load go-wasm:", e)
			})
			.then(async cmd => {
				go.env = {
					'GOPROXY': 'https://proxy.golang.org/',
					'GOROOT': '/go',
					'HOME': '/home/me',
					'PATH': '/bin:/home/me/go/bin:/go/bin/js_wasm:/go/pkg/tool/js_wasm',
				}
				go.run(cmd.instance)
				console.log(`go-wasm status: ${goWasm.ready ? 'ready' : 'not ready'}`)

				await goWasm.overlayZip('/go.zip')
				await spawn("go", "version")
				console.debug("Startup took", (new Date().getTime() - startTime) / 1000, "seconds")
				fs.mkdirSync("mywasm", 0o700)
				process.chdir("mywasm")
				await spawn("go", "mod", "init", "thing")
				await write("main.go", `
package main

func main() {
	println("Hello from WASM!")
}
`)
			})
	</script>
</head>

<body></body>

</html>
