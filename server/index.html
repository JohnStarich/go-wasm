<html>

<head>
	<meta charset="utf-8" />
	<script src="wasm_exec.js"></script>
	<script src="reload.js"></script>
	<script>
		if (!WebAssembly.instantiateStreaming) { // polyfill
			WebAssembly.instantiateStreaming = async (resp, importObject) => {
				const source = await (await resp).arrayBuffer();
				return await WebAssembly.instantiate(source, importObject);
			};
		}

		const load = (name, go) =>
			WebAssembly.instantiateStreaming(fetch(`${name}.wasm`), go.importObject)
				.catch(e => {
					console.error(`Failed to load ${name}`, e)
				})

		function runMain() {
			const go = new Go();
			return load('main', go).then(m => go.run(m.instance))
		}

		function runGo(...args) {
			const go = new Go();
			return load('go', go).then(m => {
				go.env = {
					'GOROOT': '/go',
					'HOME': process.cwd(),
				}
				go.argv = ['go', ...args]
				go.run(m.instance)
			})
		}

		function ls(path) {
			console.log(fs.readdirSync(path))
		}

		function cat(path) {
			const fd = fs.openSync(path)
			const buf = new Uint8Array(4096)
			const n = fs.readSync(fd, buf, 0, buf.length, 0)
			console.log(new TextDecoder("utf-8").decode(buf).substr(0, n))
			fs.closeSync(fd)
		}

		const go = new Go();
		load('polyfill', go)
			.then(cmd => {
				go.run(cmd.instance)
				console.log(`go-wasm status: ${goWasm.ready ? 'ready' : 'not ready'}`)

				fs.mkdirSync("/go", 0o755)
				runMain()
					.then(() => runGo('version'))
					.then(() => runGo("build", "-o", "./prog", "main.go"))
			})
	</script>
</head>

<body></body>

</html>
